# ===========================================
# CI: On push â€“ install, migrate/push, seed, build, smoke test
# Runs for: MySQL, MariaDB, PostgreSQL (matrix)
# ===========================================

name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

env:
  NODE_ENV: test
  PORT: 8000
  REDIS_HOST: 127.0.0.1
  REDIS_PORT: 6379
  JWT_ACCESS_TOKEN_SECRET: ci-secret-do-not-use-in-production
  JWT_REFRESH_TOKEN_SECRET: ci-refresh-secret-do-not-use-in-production

jobs:
  ci:
    name: ${{ matrix.database }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        database: [mysql, mariadb, postgres]
        include:
          - database: mysql
            db_image: mysql:8.0
            db_port: 3306
            db_user: root
            db_password: root
            db_name: backend_nodejs_test
            database_url: mysql://root:root@127.0.0.1:3306/backend_nodejs_test
            prisma_provider: mysql
            use_migrate: true
          - database: mariadb
            db_image: mariadb:11
            db_port: 3306
            db_user: root
            db_password: root
            db_name: backend_nodejs_test
            database_url: mysql://root:root@127.0.0.1:3306/backend_nodejs_test
            prisma_provider: mysql
            use_migrate: true
          - database: postgres
            db_image: postgres:16-alpine
            db_port: 5432
            db_user: postgres
            db_password: postgres
            db_name: backend_nodejs_test
            database_url: postgresql://postgres:postgres@127.0.0.1:5432/backend_nodejs_test?schema=public
            prisma_provider: postgresql
            use_migrate: false

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start database (${{ matrix.database }})
        run: |
          if [ "${{ matrix.database }}" = "postgres" ]; then
            docker run -d --name ci-db -p ${{ matrix.db_port }}:${{ matrix.db_port }} \
              -e POSTGRES_USER=${{ matrix.db_user }} \
              -e POSTGRES_PASSWORD=${{ matrix.db_password }} \
              -e POSTGRES_DB=${{ matrix.db_name }} \
              ${{ matrix.db_image }}
          elif [ "${{ matrix.database }}" = "mysql" ]; then
            docker run -d --name ci-db -p ${{ matrix.db_port }}:${{ matrix.db_port }} \
              -e MYSQL_ROOT_PASSWORD=${{ matrix.db_password }} \
              -e MYSQL_DATABASE=${{ matrix.db_name }} \
              ${{ matrix.db_image }} \
              --default-authentication-plugin=mysql_native_password \
              --character-set-server=utf8mb4 \
              --collation-server=utf8mb4_unicode_ci
          else
            docker run -d --name ci-db -p ${{ matrix.db_port }}:${{ matrix.db_port }} \
              -e MARIADB_ROOT_PASSWORD=${{ matrix.db_password }} \
              -e MARIADB_DATABASE=${{ matrix.db_name }} \
              ${{ matrix.db_image }} \
              --character-set-server=utf8mb4 \
              --collation-server=utf8mb4_unicode_ci
          fi
        shell: bash

      - name: Wait for database port
        run: |
          for i in $(seq 1 60); do
            if (echo >/dev/tcp/127.0.0.1/${{ matrix.db_port }}) 2>/dev/null; then
              echo "Port ${{ matrix.db_port }} open"
              exit 0
            fi
            echo "Waiting for port..."
            sleep 2
          done
          echo "Port ${{ matrix.db_port }} did not open"
          exit 1

      - name: Wait for database to accept connections
        run: |
          for i in $(seq 1 45); do
            if [ "${{ matrix.database }}" = "postgres" ]; then
              if docker exec ci-db pg_isready -U ${{ matrix.db_user }} -q 2>/dev/null; then
                echo "${{ matrix.database }} accepting connections"
                exit 0
              fi
            elif [ "${{ matrix.database }}" = "mariadb" ]; then
              if docker exec ci-db mariadb -h localhost -u ${{ matrix.db_user }} -p${{ matrix.db_password }} -e "SELECT 1" 2>/dev/null; then
                echo "${{ matrix.database }} accepting connections"
                exit 0
              fi
            else
              if docker exec ci-db mysqladmin ping -h localhost -u ${{ matrix.db_user }} -p${{ matrix.db_password }} 2>/dev/null; then
                echo "${{ matrix.database }} accepting connections"
                exit 0
              fi
            fi
            echo "Waiting for ${{ matrix.database }} to accept connections..."
            sleep 2
          done
          echo "Database did not become ready"
          exit 1
        shell: bash

      - name: Switch Prisma provider (PostgreSQL only)
        if: matrix.database == 'postgres'
        run: |
          sed -i 's/provider = "mysql"/provider = "postgresql"/' prisma/schema.prisma

      - name: Validate Prisma schema
        run: pnpm exec prisma validate
        env:
          DATABASE_URL: ${{ matrix.database_url }}

      - name: Generate Prisma Client
        run: pnpm prisma:init
        env:
          DATABASE_URL: ${{ matrix.database_url }}

      - name: Run migrations (MySQL / MariaDB)
        if: matrix.use_migrate
        run: pnpm exec prisma migrate deploy
        env:
          DATABASE_URL: ${{ matrix.database_url }}

      - name: Push schema (PostgreSQL)
        if: matrix.database == 'postgres'
        run: pnpm exec prisma db push
        env:
          DATABASE_URL: ${{ matrix.database_url }}

      - name: Seed database
        run: pnpm exec prisma db seed
        env:
          DATABASE_URL: ${{ matrix.database_url }}
          SEED_ADMIN_PASSWORD: ci-admin-secret

      - name: Build
        run: pnpm run build
        env:
          DATABASE_URL: ${{ matrix.database_url }}

      - name: Smoke test (health + DB)
        run: |
          export DATABASE_URL='${{ matrix.database_url }}'
          pnpm exec node dist/server.js &
          SERVER_PID=$!
          SERVER_UP=0
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8000/api/v1/health >/dev/null; then
              echo "Server up"
              SERVER_UP=1
              break
            fi
            sleep 1
          done
          if [ "$SERVER_UP" -ne 1 ]; then
            echo "Server did not start"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          HEALTH=$(curl -s http://127.0.0.1:8000/api/v1/health)
          echo "$HEALTH" | head -c 500
          if ! echo "$HEALTH" | grep -qE '"database"[[:space:]]*:[[:space:]]*"CONNECTED"'; then
            echo "Database not connected"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          kill $SERVER_PID 2>/dev/null || true
        shell: bash
        env:
          DATABASE_URL: ${{ matrix.database_url }}
